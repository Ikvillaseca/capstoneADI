{% extends 'base.html' %}

{% block contenido %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-route"></i> Detalle del Viaje #{{ viaje.id_viaje }}
        </h2>
        <a href="javascript:history.back()" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>

    <!-- Mapa de la ruta -->
    {% if tiene_polyline %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5><i class="fas fa-map"></i> Mapa de la Ruta</h5>
        </div>
        <div class="card-body">
            <div id="map"></div>
            {% if distancia_km %}
            <div class="mt-3">
                <span class="badge bg-info">
                    <i class="fas fa-road"></i> Distancia Total: {{ distancia_km }} km
                </span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Información principal -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header {% if viaje.tipo_viaje == 'IDA' %}bg-success{% else %}bg-info{% endif %} text-white">
                    <h5><i class="fas fa-info-circle"></i> Información del Viaje</h5>
                </div>
                <div class="card-body">
                    <p><strong>Tipo:</strong> 
                        <span class="badge {% if viaje.tipo_viaje == 'IDA' %}bg-success{% else %}bg-info{% endif %}">
                            {{ viaje.get_tipo_viaje_display }}
                        </span>
                    </p>
                    <p><strong>Hora Salida:</strong> {{ viaje.hora_salida|date:"H:i" }} - {{ viaje.hora_salida|date:"l"|capfirst }} {{ viaje.hora_salida|date:"d/m/Y" }}</p>
                    <p><strong>Hora Llegada:</strong> {{ viaje.hora_llegada|date:"H:i" }} - {{ viaje.hora_llegada|date:"l"|capfirst }} {{ viaje.hora_llegada|date:"d/m/Y" }}</p>
                    <p><strong>Punto Encuentro:</strong> {{ viaje.punto_encuentro.nombre }}</p>
                    <p class="mb-0"><strong>Dirección:</strong> {{ viaje.punto_encuentro.direccion }}</p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-user-tie"></i> Chofer y Vehículo</h5>
                </div>
                <div class="card-body">
                    <p><strong>Chofer:</strong> {{ viaje.id_chofer.nombre }} {{ viaje.id_chofer.apellido }}</p>
                    <p><strong>RUT:</strong> {{ viaje.id_chofer.rut }}</p>
                    <p><strong>Vehículo:</strong> {{ viaje.id_vehiculo.marca }} - {{ viaje.id_vehiculo.patente }}</p>
                    <p class="mb-0"><strong>Capacidad:</strong> {{ pasajeros.count }}/{{ viaje.id_vehiculo.capacidad }} pasajeros</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Itinerario de paradas -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5><i class="fas fa-map-marked-alt"></i> Itinerario de Paradas ({{ paradas.count }})</h5>
        </div>
        <div class="card-body">
            <div>
                {% for parada in paradas %}
                <div class="mb-3">
                    <div class="d-flex">
                        <div>
                            <span class="badge bg-primary rounded-circle" style="width: 30px; height: 30px; line-height: 20px;">
                                {{ parada.orden }}
                            </span>
                        </div>
                        <div class="ms-3 w-100">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">{{ parada.id_parada.nombre }}</h6>
                                    <p class="card-text text-muted mb-2">
                                        <i class="fas fa-map-marker-alt"></i> {{ parada.id_parada.direccion }}
                                    </p>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <i class="fas fa-clock text-primary"></i> 
                                            <strong>{{ parada.hora_estimada_llegada|date:"H:i" }}</strong> - {{ parada.hora_estimada_llegada|date:"(d/m/Y) " }}
                                        </div>
                                        {% if parada.pasajeros_suben > 0 %}
                                        <div class="col-md-4">
                                            <span class="badge bg-success">
                                                <i class="fas fa-arrow-up"></i> Suben: {{ parada.pasajeros_suben }}
                                            </span>
                                        </div>
                                        {% endif %}
                                        {% if parada.pasajeros_bajan > 0 %}
                                        <div class="col-md-4">
                                            <span class="badge bg-danger">
                                                <i class="fas fa-arrow-down"></i> Bajan: {{ parada.pasajeros_bajan }}
                                            </span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Lista de pasajeros -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5><i class="fas fa-users"></i> Pasajeros Asignados ({{ pasajeros.count }})</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive div-tabla">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nombre</th>
                            <th>RUT</th>
                            <th>Paradero</th>
                            <th>Teléfono</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pasajero_viaje in pasajeros %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ pasajero_viaje.id_pasajero.nombre }} {{ pasajero_viaje.id_pasajero.apellido }}</td>
                            <td>{{ pasajero_viaje.id_pasajero.rut }}</td>
                            <td>
                                {% if pasajero_viaje.id_pasajero.paradero_deseado %}
                                {{ pasajero_viaje.id_pasajero.paradero_deseado.nombre }}
                                {% else %}
                                <span class="text-muted">No asignado</span>
                                {% endif %}
                            </td>
                            <td>{{ pasajero_viaje.id_pasajero.telefono|default:"No registrado" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Cargar Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=geometry"></script>

<!-- Script del mapa -->
<script>
    let map;
    const paradas = {{ paradas_coords|safe }};
    const polylineEncoded = "{{ polyline_encoded|escapejs }}";
    const tipoViaje = "{{ viaje.tipo_viaje }}";

    function initMap() {
        // Configuración inicial del mapa
        const mapOptions = {
            zoom: 13,
            mapTypeControl: true,
            streetViewControl: false,
            fullscreenControl: true,
        };
        

        map = new google.maps.Map(document.getElementById('map'), mapOptions);

        // Verificar que la polyline existe y tiene contenido
        if (polylineEncoded && polylineEncoded.length > 0) {
            console.log("Polyline length:", polylineEncoded.length);
            
            try {
                // Decodificar y mostrar la polyline
                const decodedPath = google.maps.geometry.encoding.decodePath(polylineEncoded);
                
                if (decodedPath && decodedPath.length > 0) {
                    console.log("Decoded path points:", decodedPath.length);
                    const colorRuta = tipoViaje === 'IDA' ? '#FF6D00' : '#9C27B0';
                    const lineSymbol = {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 3,
                        strokeColor: '#FFFFFF'
                    };
                    const routeLine = new google.maps.Polyline({
                        path: decodedPath,
                        geodesic: true,
                        strokeColor: colorRuta,
                        strokeOpacity: 1.0,
                        strokeWeight: 6,
                        map: map
                    });
                    
                    const routeLineBorder = new google.maps.Polyline({
                        path: decodedPath,
                        geodesic: true,
                        strokeColor: '#000000',
                        strokeOpacity: 0.4,
                        strokeWeight: 8,
                        map: map,
                        zIndex: 1
                    });

                    // La línea principal va encima
                    routeLine.setOptions({ zIndex: 2 });

                    // Ajustar el mapa para mostrar toda la ruta
                    const bounds = new google.maps.LatLngBounds();
                    decodedPath.forEach(point => bounds.extend(point));
                    map.fitBounds(bounds);
                } else {
                    console.error("No se pudo decodificar la polyline");
                }
            } catch (error) {
                console.error("Error al decodificar polyline:", error);
            }
        } else {
            console.warn("No hay polyline disponible");
            // Centrar en la primera parada si no hay polyline
            if (paradas.length > 0) {
                map.setCenter({ lat: paradas[0].lat, lng: paradas[0].lng });
            }
        }

        // Agregar marcadores para cada parada
        paradas.forEach((parada, index) => {
            const marker = new google.maps.Marker({
                position: { lat: parada.lat, lng: parada.lng },
                map: map,
                title: parada.nombre,
                label: {
                    text: parada.orden.toString(),
                    color: 'white',
                    fontWeight: 'bold'
                },
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 14,
                    fillColor: index === 0 ? '#4CAF50' : (index === paradas.length - 1 ? '#F44336' : '#FF9800'),
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 3,
                },
                zIndex: 10
            });

            // Info window para cada parada
            const infoContent = `
                <div class="info-window">
                    <h6><strong>${parada.nombre}</strong></h6>
                    <p><i class="fas fa-clock"></i> ${parada.hora}</p>
                    ${parada.suben > 0 ? `<p><span class="badge bg-success">Suben: ${parada.suben}</span></p>` : ''}
                    ${parada.bajan > 0 ? `<p><span class="badge bg-danger">Bajan: ${parada.bajan}</span></p>` : ''}
                </div>
            `;

            const infoWindow = new google.maps.InfoWindow({
                content: infoContent
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });

            // Mostrar info del primer marcador automáticamente
            if (index === 0) {
                infoWindow.open(map, marker);
            }
        });

        // Si no hay polyline pero hay paradas, ajustar bounds a las paradas
        if ((!polylineEncoded || polylineEncoded.length === 0) && paradas.length > 0) {
            const bounds = new google.maps.LatLngBounds();
            paradas.forEach(parada => {
                bounds.extend({ lat: parada.lat, lng: parada.lng });
            });
            map.fitBounds(bounds);
        }
    }

    // Inicializar el mapa cuando el DOM esté completamente cargado
    if (document.getElementById('map')) {
        // Usar DOMContentLoaded en lugar de 'load' para mayor rapidez
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMap);
        } else {
            // El DOM ya está listo
            initMap();
        }
    }
</script>
{% endblock contenido %}